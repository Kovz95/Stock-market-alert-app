name: Deploy to Vultr

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests before deployment"
        required: false
        default: false
        type: boolean
      ssh_password:
        description: "SSH Password (leave blank to use stored secret)"
        required: false
        type: string

env:
  PYTHON_VERSION: "3.13"

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run unit tests
        run: uv run pytest tests/unit -v --tb=short
        env:
          ENVIRONMENT: development

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Set up SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Set up SSH environment
        run: |
          if [ -n "${{ github.event.inputs.ssh_password }}" ]; then
            echo "SSHPASS=${{ github.event.inputs.ssh_password }}" >> $GITHUB_ENV
          else
            echo "SSHPASS=${{ secrets.SSH_PASSWORD }}" >> $GITHUB_ENV
          fi

      - name: Package application
        run: |
          tar --exclude='.venv' \
              --exclude='__pycache__' \
              --exclude='*.pyc' \
              --exclude='.git' \
              --exclude='.github' \
              --exclude='.env' \
              --exclude='node_modules' \
              --exclude='*.log' \
              --exclude='logs/' \
              --exclude='.pytest_cache' \
              --exclude='.mypy_cache' \
              --exclude='*.egg-info' \
              --exclude='tests/' \
              --exclude='stocks.db' \
              --exclude='stockalert-deploy.tar.gz' \
              -czf stockalert-deploy.tar.gz .

      - name: Copy archive to server
        run: |
          sshpass -e scp -o StrictHostKeyChecking=no \
            stockalert-deploy.tar.gz \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Extract on server
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && tar -xzf stockalert-deploy.tar.gz && rm stockalert-deploy.tar.gz"

      - name: Deploy environment file
        run: |
          echo "${{ secrets.ENV_PRODUCTION }}" > .env.production
          sshpass -e scp -o StrictHostKeyChecking=no \
            .env.production \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/.env
          rm .env.production

      - name: Build and start Docker containers
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && docker compose down && docker compose up -d --build"

      - name: Check container status
        run: |
          sleep 5
          sshpass -e ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && docker compose ps"

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\": \"Deployment failed for ${{ github.repository }} on branch ${{ github.ref_name }}. Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true
